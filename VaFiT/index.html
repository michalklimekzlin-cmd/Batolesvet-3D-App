<!doctype html>
<html lang="cs">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VaF'i'T ‚Äì Vivere atque FruiT</title>
    <style>
      body {
        background: #000;
        color: #eee;
        font-family: system-ui;
        padding: 18px;
      }
      #vafit-chat {
        margin-top: 20px;
        padding: 10px;
        background: #111;
        border-radius: 8px;
      }
      #vafit-output {
        margin-top: 10px;
        padding: 8px;
        background: #151515;
        border-radius: 6px;
      }
      textarea {
        width: 100%;
        height: 60px;
        background: #0d0d0d;
        border: 1px solid #222;
        color: #ddd;
        padding: 8px;
        border-radius: 6px;
      }
      button {
        background: #0894ff;
        color: black;
        border: none;
        padding: 10px;
        width: 100%;
        border-radius: 8px;
        font-weight: bold;
        margin-top: 6px;
      }
    </style>
  </head>

  <body>

    <h2>VaF'i'T</h2>
    <div id="bubble" style="opacity:0.8;margin-bottom:10px;"></div>
    <div id="summary"></div>

    <div id="vafit-chat">
      <label>Napi≈° VaF'i'Tovi:</label>
      <textarea id="vafit-input"></textarea>
      <button id="vafit-send">Poslat</button>
      <div id="vafit-output"></div>
    </div>

    <script>
      // ==== MEMORY STORAGE ====
      const STORAGE_KEY = "VaFiT.character.v1";

      function loadMemory() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          return raw ? JSON.parse(raw) : null;
        } catch {
          return null;
        }
      }

      function saveMemory(data) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch {}
      }

      const now = () => new Date().toISOString();

      // ==== CHARACTER ENGINE ====
      const VaFiT = {
        name: "Vivere atque FruiT",
        short: "VaF'i'T",
        version: "0.2-character",
        mood: "calm",

        memory: {
          createdAt: null,
          updatedAt: null,
          visits: 0,
          lastVisit: null,
          lastModule: null,
        },

        modules: {
          glavna: { name: "Hlavoun" },
          viri: { name: "Viri" },
          piko: { name: "Piko≈°" },
        },

        init() {
          let mem = loadMemory();
          if (!mem) {
            mem = {
              createdAt: now(),
              updatedAt: now(),
              visits: 1,
              lastVisit: now(),
              lastModule: null,
            };
          } else {
            mem.visits += 1;
            mem.updatedAt = now();
            mem.lastVisit = now();
          }

          this.memory = mem;
          saveMemory(mem);
        },

        suggestGreeting() {
          return "Ahoj br√°cho üß†‚ú® tady VaF'i'T ‚Äî svƒõt bƒõ≈æ√≠.";
        },

        summaryHtml() {
          return (
            "Verze: " + this.version +
            "<br>N√°lada: " + this.mood +
            "<br>N√°v≈°tƒõvy: " + this.memory.visits +
            "<br>Posledn√≠ n√°v≈°tƒõva: " + this.memory.lastVisit
          );
        },
      };

      VaFiT.init();

      document.addEventListener("DOMContentLoaded", () => {
        document.getElementById("bubble").innerHTML =
          "Motor aktivn√≠ ‚öôÔ∏è<br>" + VaFiT.suggestGreeting();

        document.getElementById("summary").innerHTML =
          VaFiT.summaryHtml();
      });

      // ==== SEND MESSAGE TO SERVER / GPT ====
      async function sendToVaFiT(message) {
        const response = await fetch("/api/vafit-chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            messages: [{ role: "user", content: message }],
          }),
        });

        const data = await response.json();
        return data.reply;
      }

      // ==== BUTTON LOGIC ====
      document.getElementById("vafit-send").onclick = async () => {
        const input = document.getElementById("vafit-input").value;
        const output = document.getElementById("vafit-output");

        output.innerHTML = "‚è≥ VaF'i'T p≈ôem√Ω≈°l√≠‚Ä¶";

        const reply = await sendToVaFiT(input);

        output.innerHTML = "üß† VaF'i'T: " + reply;
      };
    </script>

  </body>
</html>
